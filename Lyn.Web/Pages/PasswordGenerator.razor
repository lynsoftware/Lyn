@page "/PasswordGenerator"
@layout PasswordGeneratorLayout
@inject IPasswordGenerationService PasswordService
@inject IJSRuntime JS
@inject ILocalStorageService LocalStorage
@inject IStringLocalizer<Localization> Localizer

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="password-generator-container">

    <!-- Download App Banner -->
    <div class="card-dark mb-30">
        <div class="download-content">
            <div class="icon-yellow icon-medium">
                <i class="bi bi-download"></i>
            </div>
            <div class="download-text">
                <h3 class="title-yellow title-small" style="margin: 0 0 4px 0;">
                    @Localizer["DownloadBanner_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["DownloadBanner_Description"] 
                    <a href="/download" class="download-link">@Localizer["DownloadBanner_Link"]</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Help button -->
    <div class="text-end mb-3">
        <button type="button"
                class="btn help-link"
                @onclick="ShowHowToUse">
            <i class="bi bi-question-circle-fill me-1"></i>
            @Localizer["HowToUse"]
        </button>
    </div>

    <EditForm Model="PasswordGenerationRequest"
              FormName="PasswordGenerationForm"
              OnValidSubmit="@OnSuccess">
        <fieldset disabled="@_isSubmitting" style="border: none; padding: 0; margin: 0;">
            <DataAnnotationsValidator/>

            <!-- Master Password Section -->
            <div class="form-section">
                <label class="form-label-bold">@Localizer["MasterPassword_Label"]</label>

                <div class="input-container">
                    <div class="password-input-wrapper">
                        <input id="masterPassword"
                               type="@PasswordInputType"
                               class="form-input @(_masterPasswordError ? "input-error" : "")"
                               placeholder="@Localizer["MasterPassword_Placeholder"]"
                               value="@PasswordGenerationRequest.MasterPassword"
                               @oninput="@(e =>
                                         {
                                             PasswordGenerationRequest.MasterPassword = e.Value?.ToString() ?? "";
                                             OnMasterPasswordChanged();
                                         })"/>
                        <button type="button"
                                class="password-toggle-icon"
                                @onclick="TogglePasswordVisibility"
                                tabindex="-1"
                                title="@(_isPasswordVisible ? Localizer["MasterPassword_Hide"] : Localizer["MasterPassword_Show"])">
                            <i class="@(_isPasswordVisible ? "bi bi-eye-slash" : "bi bi-eye")"></i>
                        </button>
                    </div>
                </div>

                @if (_masterPasswordError)
                {
                    <div class="error-message">@Localizer["MasterPassword_Required"]</div>
                }
            </div>

            <!-- Seed Section -->
            <div class="form-section">
                <label class="form-label-bold">@Localizer["Seed_Label"]</label>

                <div class="input-container">
                    <input id="seed"
                           type="text"
                           placeholder="@Localizer["Seed_Placeholder"]"
                           class="form-input @(_seedError ? "input-error" : "")"
                           value="@PasswordGenerationRequest.Seed"
                           @oninput="@(e =>
                                     {
                                         PasswordGenerationRequest.Seed = e.Value?.ToString() ?? "";
                                         OnSeedChanged();
                                     })"/>
                </div>

                @if (_seedError)
                {
                    <div class="error-message">@Localizer["Seed_Required"]</div>
                }
            </div>

            <!-- Password Length Section -->
            <div class="form-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label-bold mb-0">@Localizer["PasswordLength_Label"]</label>
                </div>

                <div class="row align-items-center g-3">
                    <div class="col">
                        <RangeInput id="length"
                                    TValue="int"
                                    @bind-Value="PasswordGenerationRequest.Length"
                                    Min="AppConstants.PasswordMinLength"
                                    Max="AppConstants.PasswordMaxLength"
                                    class="custom-range"/>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="slider-label">@AppConstants.PasswordMinLength</small>
                            <small class="slider-label">@AppConstants.PasswordMaxLength</small>
                        </div>
                    </div>

                    <div class="col-auto">
                        <div class="length-input-container">
                            <InputNumber id="lengthInput"
                                         class="length-input"
                                         @bind-Value="PasswordGenerationRequest.Length"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Special Characters Section -->
            <div class="special-chars-container">
                <div class="d-flex align-items-center">
                    <CheckboxInput @bind-Value="PasswordGenerationRequest.IncludeSpecialChars"
                                   class="special-chars-checkbox"/>
                    <label class="special-chars-label ms-2 mb-0">
                        @string.Format(Localizer["SpecialChars_Label"], AppConstants.SpecialChars)
                    </label>
                </div>
            </div>

            <!-- Generate Button -->
            <button type="submit"
                    class="btn-primary-yellow @(_isShaking ? "shake-animation" : "")"
                    disabled="@_isSubmitting">
                <i class="bi bi-lightning-fill me-2"></i>
                <span>@Localizer["GeneratePassword_Button"]</span>
            </button>

            @if (_errorMessage != null)
            {
                <div class="alert alert-danger mt-3">
                    @_errorMessage
                </div>
            }

            @if (_generatedPassword != null)
            {
                <!-- Result Section -->
                <div class="result-container" @onclick="CopyToClipboard">
                    <div class="generated-password">@_generatedPassword</div>
                </div>

                <!-- Copy Button -->
                <button type="button"
                        class="btn-primary-yellow"
                        @onclick="CopyToClipboard"
                        disabled="@_isCopying">
                    <i class="bi @(_isCopying ? "bi-check-lg" : "bi-clipboard") me-2"></i>
                    <span>@(_isCopying ? Localizer["Copied_Button"] : Localizer["CopyToClipboard_Button"])</span>
                </button>
            }
        </fieldset>
    </EditForm>
</div>

<HowToUseModal @bind-IsVisible="_showHowToUseModal" />

@code {
    
    [SupplyParameterFromForm]
    public PasswordGenerationRequest PasswordGenerationRequest { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        PasswordGenerationRequest ??= new();
        await LoadPreferences();
    }

    private string? _generatedPassword;
    private bool _isSubmitting;
    private bool _isShaking;
    private bool _isCopying;
    private bool _isPasswordVisible = false;
    private bool _masterPasswordError = false;
    private bool _seedError = false;
    
    private bool _showHowToUseModal = false;

    private void ShowHowToUse()
    {
        _showHowToUseModal = true;
    }

    private string PasswordInputType => _isPasswordVisible ? "text" : "password";
    private string? _errorMessage;

    private async Task OnSuccess()
    {
        _errorMessage = null;
        _masterPasswordError = false;
        _seedError = false;

        if (string.IsNullOrWhiteSpace(PasswordGenerationRequest.MasterPassword))
        {
            _masterPasswordError = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(PasswordGenerationRequest.Seed))
        {
            _seedError = true;
            return;
        }

        _isSubmitting = true;
        _isShaking = true;

        var result = await PasswordService.GeneratePasswordAsync(PasswordGenerationRequest);

        if (result.IsFailure)
        {
            _errorMessage = result.Error;
        }
        else
        {
            _generatedPassword = result.Value?.Value ?? string.Empty;
            await SavePreferences();
        }

        _isSubmitting = false;
        await Task.Delay(500);
        _isShaking = false;
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(_generatedPassword))
        {
            _isCopying = true;
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _generatedPassword);
            StateHasChanged();
            await Task.Delay(1500);

            _isCopying = false;
        }
    }

    private async Task TogglePasswordVisibility()
    {
        _isPasswordVisible = !_isPasswordVisible;
        await LocalStorage.SetItemAsync(
            AppConstants.PreferenceKeyPasswordVisible,
            _isPasswordVisible);
    }

    private void OnMasterPasswordChanged()
    {
        if (!string.IsNullOrWhiteSpace(PasswordGenerationRequest.MasterPassword))
        {
            _masterPasswordError = false;
        }
    }

    private void OnSeedChanged()
    {
        if (!string.IsNullOrWhiteSpace(PasswordGenerationRequest.Seed))
        {
            _seedError = false;
        }
    }

    private async Task LoadPreferences()
    {
        try
        {
            var savedPasswordVisible = await LocalStorage.GetItemAsync<bool?>(
                AppConstants.PreferenceKeyPasswordVisible);
            _isPasswordVisible = savedPasswordVisible ?? false;

            var savedLength = await LocalStorage.GetItemAsync<int?>(
                AppConstants.PreferenceKeyPasswordLength);

            PasswordGenerationRequest.Length = savedLength ?? AppConstants.PasswordDefaultLength;

            var savedSpecialChars = await LocalStorage.GetItemAsync<bool?>(
                AppConstants.PreferenceKeyIncludeSpecialChars);

            PasswordGenerationRequest.IncludeSpecialChars = savedSpecialChars
                                                            ?? AppConstants.PasswordDefaultIncludeSpecialChars;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load preferences: {ex.Message}");
            PasswordGenerationRequest.Length = AppConstants.PasswordDefaultLength;
            PasswordGenerationRequest.IncludeSpecialChars = AppConstants.PasswordDefaultIncludeSpecialChars;
        }
    }

    private async Task SavePreferences()
    {
        try
        {
            await LocalStorage.SetItemAsync(
                AppConstants.PreferenceKeyPasswordLength,
                PasswordGenerationRequest.Length);

            await LocalStorage.SetItemAsync(
                AppConstants.PreferenceKeyIncludeSpecialChars,
                PasswordGenerationRequest.IncludeSpecialChars);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save preferences: {ex.Message}");
        }
    }
}