@page "/support"
@using Lyn.Shared.Helpers
@using Lyn.Shared.Models.Request
@using Lyn.Web.Services.Api
@layout PasswordGeneratorLayout
@inject IStringLocalizer<Localization> Localizer
@inject ISupportTicketService SupportTicketService
@inject ILogger<Support> Logger
@implements IDisposable

<PageTitle>@Localizer["Support_PageTitle"]</PageTitle>

<div class="container-medium">

    <!-- Title and subtitle -->
    <div class="page-header">
        <h1 class="text-theme-primary title-xlarge" style="font-weight: bold; margin-bottom: 20px;">
            @Localizer["Support_Title"]
        </h1>
        <p class="text-theme-primary" style="font-size: 14px; opacity: 0.8;">
            @Localizer["Support_Subtitle"]
        </p>
    </div>


    <div class="main-content">

        @if (_isSubmitted)
        {
            <section class="main-section">
                <div class="privacy-summary" 
                     style="background-color: rgba(76, 175, 80, 0.1); 
                             border-left: 4px solid #4CAF50; 
                             padding: 20px; 
                             border-radius: 8px;">
                    <h2 class="text-theme-primary title-medium" 
                        style="color: #4CAF50; margin-bottom: 10px;">@Localizer["Support_Success_Title"]</h2>
                    <p class="text-theme-primary">
                        @Localizer["Support_Success_Message", _supportTicketModel.Email]
                    </p>
                    <button @onclick="ResetForm" class="btn-primary-yellow" style="margin-top: 15px;">
                        @Localizer["Support_Button_SendNew"]
                    </button>
                </div>
            </section>
        }
        else
        {
            <EditForm Model="@_supportTicketModel" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <section class="main-section">
                    <div class="form-section">
                        <label for="email" class="main-label">
                            @Localizer["Support_Label_Email"]
                        </label>
                        <div class="input-container">
                            <InputText id="email"
                                       @bind-Value="_supportTicketModel.Email"
                                       class="form-input"
                                       placeholder="@Localizer["Support_Placeholder_Email"]" />
                        </div>
                        <ValidationMessage For="@(() => _supportTicketModel.Email)"/>
                    </div>

                    <div class="form-section">
                        <label for="title" class="main-label">
                            @Localizer["Support_Label_Title"]
                        </label>
                        <div class="input-container">
                            <InputText id="title"
                                       @bind-Value="_supportTicketModel.Title"
                                       class="form-input"
                                       placeholder="@Localizer["Support_Placeholder_Title"]" />
                        </div>
                        <ValidationMessage For="@(() => _supportTicketModel.Title)" />
                    </div>

                    <div class="form-section">
                        <label for="category" class="main-label">
                            @Localizer["Support_Label_Category"]
                        </label>
                        <div class="input-container">
                            <InputSelect id="category"
                                         @bind-Value="_supportTicketModel.Category"
                                         class="form-input">
                                <option value="">@Localizer["Support_Category_SelectPlaceholder"]</option>
                                <option value="Testing">@Localizer["Support_Category_Testing"]</option>
                                <option value="Bug">@Localizer["Support_Category_Bug"]</option>
                                <option value="Feature">@Localizer["Support_Category_Feature"]</option>
                                <option value="Question">@Localizer["Support_Category_Question"]</option>
                                <option value="Security">@Localizer["Support_Category_Security"]</option>
                                <option value="Other">@Localizer["Support_Category_Other"]</option>
                            </InputSelect>
                        </div>
                        <ValidationMessage For="@(() => _supportTicketModel.Category)" />
                    </div>

                    <div class="form-section">
                        <label for="description" class="main-label">
                            @Localizer["Support_Label_Description"]
                        </label>
                        <div >
                            <InputTextArea id="description"
                                           @bind-Value="_supportTicketModel.Description"
                                           class="form-textarea"
                                           placeholder="@Localizer["Support_Placeholder_Description"]"
                                           rows="8" />
                        </div>
                        <ValidationMessage For="@(() => _supportTicketModel.Description)"/>
                    </div>

                    <div class="form-section">
                        <label for="images" class="main-label">
                            @Localizer["Support_Label_Attachments"]
                        </label>
                        <p class="text-theme-primary less-visible-info-text">
                            @Localizer["Support_Attachments_Info"]
                        </p>
                        <div class="upload-image-section">
                            <InputFile id="images"
                                       OnChange="HandleFileSelection"
                                       multiple
                                       accept="image/*"
                                       class="form-input-file" />

                            @if (_selectedFiles.Count > 0)
                            {
                                <div style="margin-top: 15px; padding: 12px;">
                                    <p class="text-theme-primary">
                                        @Localizer["Support_Files_Selected", _selectedFiles.Count]
                                    </p>
                                    <ul class="main-list">
                                        @foreach (var file in _selectedFiles)
                                        {
                                            <li class="text-theme-primary list-with-remove-button-style">
                                                <span>@file.Name (@FileHelper.FormatFileSize(file.Size))</span>
                                                <button type="button"
                                                        @onclick="() => RemoveFile(file)"
                                                        class="btn-remove remove-button-small">
                                                    âœ•
                                                </button>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(_fileError))
                            {
                                <div style="margin-top: 15px; padding: 12px;">
                                    <p class="validation-message" style="margin-top: 10px;">@_fileError</p>
                                </div>
                            }
                        </div>

                    </div>

                    <button type="submit" class="btn-primary-yellow" disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span>@Localizer["Support_Button_Sending"]</span>
                        }
                        else
                        {
                            <span>@Localizer["Support_Button_Send"]</span>
                        }
                    </button>
                </section>
            </EditForm>
        }

        <section class="main-section more-space-between-sections">
            <h2 class="text-theme-primary title-medium">@Localizer["Support_Alternative_Contact_Title"]</h2>
            <p class="text-theme-primary">
                @Localizer["Support_Alternative_Contact_Text"]
            </p>
            <p class="text-theme-primary">
                <a href="mailto:support@lynsoftware.com" class="download-link link-text-size" >
                    support@lynsoftware.com
                </a>
            </p>
        </section>
    </div>

</div>


@code {
    private SupportTicketRequest _supportTicketModel = new();
    private List<IBrowserFile> _selectedFiles = [];
    private bool _isSubmitting;
    private bool _isSubmitted;
    private string? _fileError;


    private CancellationTokenSource _cts = new();

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        _fileError = string.Empty;

        var newFiles = e.GetMultipleFiles(SupportTicketFileConfig.TicketMaxFileCount);

        if (_selectedFiles.Count + newFiles.Count() > SupportTicketFileConfig.TicketMaxFileCount)
        {
            _fileError = Localizer["Support_Error_MaxFiles", SupportTicketFileConfig.TicketMaxFileCount];
            return;
        }

        foreach (var file in newFiles)
        {
            if (file.Size > SupportTicketFileConfig.TicketMaxFileSizeBytes)
            {
                _fileError = Localizer["Support_Error_FileSize", file.Name];
                continue;
            }

            if (!file.ContentType.StartsWith("image/"))
            {
                _fileError = Localizer["Support_Error_InvalidImage", file.Name];
                continue;
            }

            _selectedFiles.Add(file);
        }
    }

    private void RemoveFile(IBrowserFile file)
    {
        _selectedFiles.Remove(file);
        _fileError = string.Empty;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _fileError = string.Empty;

        try
        {
            var result = await SupportTicketService.CreateSupportTicketAsync(
                _supportTicketModel, 
                _selectedFiles.Count > 0 ? _selectedFiles : null, _cts!.Token);

            if (result.IsFailure)
                _fileError = result.Error; 
            else
                _isSubmitted = true;
            
        }
        catch (Exception ex)
        {
            _fileError = Localizer["Support_Error_Submit"];
            Logger.LogError($"Error sending submit ticket: {ex}");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void ResetForm()
    {
        _supportTicketModel = new();
        _selectedFiles.Clear();
        _fileError = string.Empty;
        _isSubmitted = false;
    }
    
    protected override void OnInitialized()
    {
        _cts = new CancellationTokenSource();
    }

    
    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }


}