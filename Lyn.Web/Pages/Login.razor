@page "/Login"
@using Lyn.Shared.Enum
@using Lyn.Web.Services.Api
@using Lyn.Shared.Models.Request
@inject ILogger<Login> Logger
@inject IAuthService AuthService

<section class="signup">
    <div class="text-center mt-3">
        <h2>Login</h2>
    </div>
    
    @if (_errorMessage != null)
    {
        <p>@_errorMessage</p>
    }
    <EditForm Model="LoginRequest" OnValidSubmit="OnSuccess" FormName="LoginForm">
        <fieldset disabled="@_isLoggingIn">
            <DataAnnotationsValidator/>

            <div class="mb-3">
                <label for="email" class="form-label">Email:</label>
                <InputText id="email" class="form-control" @bind-Value="@LoginRequest.Email"></InputText>
                <ValidationMessage For="@(() => LoginRequest.Email)"/>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password:</label>
                <PasswordInput Id="password" @bind-Value="@LoginRequest.Password"/>
                <ValidationMessage For="@(() => LoginRequest.Password)"/>
            </div>

            <div class="text-center mt-3">
                @if (_isLoggingIn)
                {
                    <div class="text-center my-3">
                        <div class="spinner-border primary-color" role="status">
                            <span class="visually-hidden">Logging in...</span>
                        </div>
                        <p class="mt-2">Logging in...</p>
                    </div>
                }
                else
                {
                    <button type="submit" class="btn custom-primary-btn">Login</button>
                }
            </div>
        </fieldset>
    </EditForm>
    
    <p class="text-center mt-3">
        Dont have an account? <a href="/signup">Sign up now!</a>
    </p>
    <p class="text-center mt-3">
        Forgotten password? <a href="/forgotten-password">Press here</a>
    </p>
    
    <hr class="my-4"/>
</section>

@code {
    [SupplyParameterFromForm]
    public LoginRequest LoginRequest { get; set; } = new();

    private string? _errorMessage;
    private bool _isLoggingIn;

    private CancellationTokenSource? _cts;

    private async Task OnSuccess()
    {
        _isLoggingIn = true;
        
        try
        {
            var result = await AuthService.LoginAsync(LoginRequest, _cts!.Token);
            
            if (!result.IsSuccess)
            {
                _errorMessage = result.Error;
            }
            else
            {
                _errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
            Logger.LogError(ex, "Unexpected error during login");
        }
        finally
        {
            _isLoggingIn = false;
        }
    }
    

    protected override void OnInitialized() => _cts = new CancellationTokenSource();

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}