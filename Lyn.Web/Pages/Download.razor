@page "/download"
@using Lyn.Shared.Enum
@using Lyn.Shared.Models.Response
@using Lyn.Web.Services.Api
@layout PasswordGeneratorLayout
@inject IStringLocalizer<Localization> Localizer
@inject IDownloadService DownloadService
@inject ILogger<Download> Logger
@inject IJSRuntime JSRuntime

<PageTitle>@Localizer["Download_PageTitle"]</PageTitle>

<div class="container-wide">

    <!-- Hero Section -->
    <div class="download-hero">
        <div class="icon-yellow icon-xlarge">
            <i class="bi bi-shield-lock-fill"></i>
        </div>
        <h1 class="text-theme-primary title-xlarge">@Localizer["Download_Hero_Title"]</h1>
        <p class="text-theme-primary" style="font-size: 18px; margin: 10px 0 0 0; opacity: 0.9;">
            @Localizer["Download_Hero_Subtitle"]
        </p>
    </div>

    @if (_errorMessage != null)
    {
        <div class="alert alert-danger text-center" role="alert">
            @_errorMessage
        </div>
    }
    

    <!-- Desktop Downloads -->
    <div class="section-spacing-large">
        <h2 class="text-theme-primary title-large mb-20" style="display: flex; align-items: center;">
            <i class="bi bi-laptop me-2"></i>
            @Localizer["Download_Desktop_Title"]
        </h2>

        <div class="download-grid">
            <!-- Windows -->
            <DownloadCard
                IconClass="windows"
                Title="@Localizer["Download_Windows_Title"]"
                Subtitle="@GetDownloadForPlatform(ReleaseType.WindowsInstaller)?.Version"
                ButtonText="@Localizer["Download_Windows_Button"]"
                IsAvailable="@IsDownloadAvailable(ReleaseType.WindowsInstaller)"
                IsDownloading="@_isDownloading"
                StoreUrl="https://apps.microsoft.com/detail/9P1X3L10CQ1P?hl=nb-no&gl=NO"
                StoreText="@Localizer["Download_Windows_Store"]"
                OnDownloadClick="@(async () 
                                     => await OnDownload(GetDownloadForPlatform(
                                         ReleaseType.WindowsInstaller)!))"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]" />

            <!-- macOS -->
            <DownloadCard 
                IconClass="apple"
                Title="@Localizer["Download_MacOS_Title"]"
                Subtitle="@GetDownloadForPlatform(ReleaseType.MacOS)?.Version"
                ButtonText="@Localizer["Download_MacOS_Button"]"
                IsAvailable="@IsDownloadAvailable(ReleaseType.MacOS)"
                IsDownloading="@_isDownloading"
                StoreUrl="https://apps.apple.com/no/app/lyn-password-generator/id6757705391?l=nb&platform=mac"
                StoreText="@Localizer["Download_MacOS_Store"]"
                OnDownloadClick="@(async () 
                                     => await OnDownload(GetDownloadForPlatform(ReleaseType.MacOS)!))"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]" />

            <!-- Linux -->
            <DownloadCard 
                IconClass="ubuntu"
                Title="@Localizer["Download_Linux_Title"]"
                Subtitle="@GetDownloadForPlatform(ReleaseType.Linux)?.Version"
                ButtonText="@Localizer["Download_Linux_Button"]"
                IsAvailable="@IsDownloadAvailable(ReleaseType.Linux)"
                IsDownloading="@_isDownloading"
                OnDownloadClick="@(async () 
                                     => await OnDownload(GetDownloadForPlatform(ReleaseType.Linux)!))"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]" />
        </div>
    </div>

    <!-- Mobile Downloads -->
    <div class="section-spacing-large">
        <h2 class="text-theme-primary title-large mb-20" style="display: flex; align-items: center;">
            <i class="bi bi-phone me-2"></i>
            @Localizer["Download_Mobile_Title"]
        </h2>

        <div class="download-grid">
            <!-- Android -->
            <DownloadCard 
                IconClass="android2"
                Title="@Localizer["Download_Android_Title"]"
                Subtitle="@GetDownloadForPlatform(ReleaseType.AndroidApk)?.Version"
                ButtonText="@Localizer["Download_Android_Button"]"
                IsAvailable="@IsDownloadAvailable(ReleaseType.AndroidApk)"
                IsDownloading="@_isDownloading"
                StoreUrl="https://play.google.com/store/apps/details?id=com.lynsoftware.lynpasswordgenerator"
                StoreText="@Localizer["Download_Android_Store"]"
                OnDownloadClick="@(async () 
                                     => await OnDownload(GetDownloadForPlatform(
                                         ReleaseType.AndroidApk)!))"
                ComingSoonText="@Localizer["Download_ComingSoon_Q3"]" />

            <!-- iOS & iPad -->
            <DownloadCard 
                IconClass="apple"
                Title="@Localizer["Download_Apple_Mobile_Title"]"
                Subtitle="@GetDownloadForPlatform(ReleaseType.iOS)?.Version"
                ButtonText="@Localizer["Download_iOS_Button"]"
                IsAvailable="true"
                IsDownloading="@_isDownloading"
                StoreUrl="https://apps.apple.com/no/app/lyn-password-generator/id6757705391?l=nb"
                StoreText="@Localizer["Download_iOS_Store"]"
                SecondaryStoreUrl="https://apps.apple.com/no/app/lyn-password-generator/id6757705391?l=nb&platform=ipad"
                SecondaryStoreText="@Localizer["Download_iPad_Store"]"
                ComingSoonText="@Localizer["Download_ComingSoon_Q3"]" />
        </div>
    </div>

    <!-- Features Section -->
    <div class="card-dark" style="margin-top: 50px; padding: 40px;">
        <h2 class="title-yellow title-large mb-30" style="text-align: center;">
            @Localizer["Download_WhyDownload_Title"]
        </h2>
        <div class="features-grid">
            <div class="feature-card">
                <i class="bi bi-lightning-charge-fill icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Performance_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Performance_Description"]
                </p>
            </div>
            <div class="feature-card">
                <i class="bi bi-wifi-off icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Offline_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Offline_Description"]
                </p>
            </div>
            <div class="feature-card">
                <i class="bi bi-shield-check icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Secure_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Secure_Description"]
                </p>
            </div>
        </div>
    </div>

    <!-- Back to Web Generator -->
    <div class="web-generator-section">
        <p class="text-theme-primary" style="font-size: 16px; margin: 0 0 20px 0;">
            @Localizer["Download_WebGenerator_Text"]
        </p>
        <a href="/passwordgenerator" class="btn-primary-yellow">
            <i class="bi bi-globe"></i>
            <span>@Localizer["Download_WebGenerator_Button"]</span>
        </a>
    </div>

</div>

@code
{
    public List<AppReleaseResponse> Downloads = new();

    private bool _isLoading = true;
    private bool _isDownloading;
    private string? _errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await DownloadService.GetLatestDownloadsAsync();
        
            if (result.IsFailure)
            {
                _errorMessage = result.Error;
                Logger.LogError("Failed to load downloads: {Error}", result.Error);
            }
            else
            {
                Downloads = result.Value!;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool IsDownloadAvailable(ReleaseType type)
    {
        return Downloads.Any(d => d.Type == type);
    }

    private AppReleaseResponse? GetDownloadForPlatform(ReleaseType platform)
    {
        return Downloads.FirstOrDefault(d => d.Type == platform);
    }
    
    private async Task OnDownload(AppReleaseResponse appRelease)
    {
        _isDownloading = true;
        _errorMessage = null;
        
        try
        {
            var result = await DownloadService.GetDownloadAsync(appRelease.Id);

            if (result.IsFailure)
            {
                _errorMessage = result.Error;
                Logger.LogError("Failed to download: {Error}", result.Error);
                return;
            }
            
            var fileDownload = result.Value!;
            
            // Trigger browser download using JavaScript Interop
            await JSRuntime.InvokeVoidAsync(
                "fileDownload.downloadFile",
                fileDownload.FileName,
                fileDownload.ContentType,
                fileDownload.FileData);
            
            Logger.LogInformation("Successfully downloaded {FileName}", fileDownload.FileName);
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred during download";
            Logger.LogError(ex, "Unexpected error during download");
        }
        finally
        {
            _isDownloading = false;
            StateHasChanged();
        }
    }
}
