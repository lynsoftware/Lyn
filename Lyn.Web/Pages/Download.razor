@page "/download"
@using Lyn.Backend.Models.Enums
@using Lyn.Web.Services.Api
@layout PasswordGeneratorLayout
@inject IStringLocalizer<Localization> Localizer
@inject IDownloadService DownloadService
@inject ILogger<Download> Logger
@inject IJSRuntime JSRuntime

<PageTitle>@Localizer["Download_PageTitle"]</PageTitle>

<div class="container-wide">

    <!-- Hero Section -->
    <div class="download-hero">
        <div class="icon-yellow icon-xlarge">
            <i class="bi bi-shield-lock-fill"></i>
        </div>
        <h1 class="text-theme-primary title-xlarge">@Localizer["Download_Hero_Title"]</h1>
        <p class="text-theme-primary" style="font-size: 18px; margin: 10px 0 0 0; opacity: 0.9;">
            @Localizer["Download_Hero_Subtitle"]
        </p>
    </div>

    @if (_errorMessage != null)
    {
        <div class="alert alert-danger text-center" role="alert">
            @_errorMessage
        </div>
    }
    

    <!-- Desktop Downloads -->
    <div class="section-spacing-large">
        <h2 class="text-theme-primary title-large mb-20" style="display: flex; align-items: center;">
            <i class="bi bi-laptop me-2"></i>
            @Localizer["Download_Desktop_Title"]
        </h2>

        <div class="download-grid">
            <!-- Windows -->
            <DownloadCard
                IconClass="windows"
                Title="@Localizer["Download_Windows_Title"]"
                Subtitle="@Localizer["Download_Windows_Subtitle"]"
                ButtonText="@Localizer["Download_Windows_Button"]"
                IsAvailable="@IsDownloadAvailable(DownloadPlatform.Windows)"
                IsDownloading="@_isDownloading"
                Version="@GetDownloadForPlatform(DownloadPlatform.Windows)?.Version"
                StoreUrl="ms-windows-store://pdp/?productid=9P5RJK0RQR8W"
                StoreText="@Localizer["Download_Windows_Store"]"
                OnDownloadClick="@(async () => await OnDownload(GetDownloadForPlatform(DownloadPlatform.Windows)!))"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]" />

            <!-- macOS -->
            <DownloadCard 
                IconClass="apple"
                Title="@Localizer["Download_MacOS_Title"]"
                Subtitle="@Localizer["Download_MacOS_Subtitle"]"
                ButtonText="@Localizer["Download_MacOS_Button"]"
                IsAvailable="@IsDownloadAvailable(DownloadPlatform.MacOS)"
                IsDownloading="@_isDownloading"
                Version="@GetDownloadForPlatform(DownloadPlatform.MacOS)?.Version"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]"
                OnDownloadClick="@(async () => await OnDownload(GetDownloadForPlatform(DownloadPlatform.MacOS)!))" />

            <!-- Linux -->
            <DownloadCard 
                IconClass="ubuntu"
                Title="@Localizer["Download_Linux_Title"]"
                Subtitle="@Localizer["Download_Linux_Subtitle"]"
                ButtonText="@Localizer["Download_Linux_Button"]"
                IsAvailable="@IsDownloadAvailable(DownloadPlatform.Linux)"
                IsDownloading="@_isDownloading"
                Version="@GetDownloadForPlatform(DownloadPlatform.Linux)?.Version"
                ComingSoonText="@Localizer["Download_ComingSoon_Q2"]"
                OnDownloadClick="@(async () => await OnDownload(GetDownloadForPlatform(DownloadPlatform.Linux)!))" />
        </div>
    </div>

    <!-- Mobile Downloads -->
    <div class="section-spacing-large">
        <h2 class="text-theme-primary title-large mb-20" style="display: flex; align-items: center;">
            <i class="bi bi-phone me-2"></i>
            @Localizer["Download_Mobile_Title"]
        </h2>

        <div class="download-grid">
            <!-- Android -->
            <DownloadCard 
                IconClass="android2"
                Title="@Localizer["Download_Android_Title"]"
                Subtitle="@Localizer["Download_Android_Subtitle"]"
                ButtonText="@Localizer["Download_Android_Button"]"
                IsAvailable="@IsDownloadAvailable(DownloadPlatform.Android)"
                IsDownloading="@_isDownloading"
                Version="@GetDownloadForPlatform(DownloadPlatform.Android)?.Version"
                ComingSoonText="@Localizer["Download_ComingSoon_Q3"]"
                OnDownloadClick="@(async () => await OnDownload(GetDownloadForPlatform(DownloadPlatform.Android)!))" />

            <!-- iOS -->
            <DownloadCard 
                IconClass="apple"
                Title="@Localizer["Download_iOS_Title"]"
                Subtitle="@Localizer["Download_iOS_Subtitle"]"
                ButtonText="@Localizer["Download_iOS_Button"]"
                IsAvailable="@IsDownloadAvailable(DownloadPlatform.iOS)"
                IsDownloading="@_isDownloading"
                Version="@GetDownloadForPlatform(DownloadPlatform.iOS)?.Version"
                ComingSoonText="@Localizer["Download_ComingSoon_Q3"]"
                OnDownloadClick="@(async () => await OnDownload(GetDownloadForPlatform(DownloadPlatform.iOS)!))" />
        </div>
    </div>

    <!-- Features Section -->
    <div class="card-dark" style="margin-top: 50px; padding: 40px;">
        <h2 class="title-yellow title-large mb-30" style="text-align: center;">
            @Localizer["Download_WhyDownload_Title"]
        </h2>
        <div class="features-grid">
            <div class="feature-card">
                <i class="bi bi-lightning-charge-fill icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Performance_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Performance_Description"]
                </p>
            </div>
            <div class="feature-card">
                <i class="bi bi-wifi-off icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Offline_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Offline_Description"]
                </p>
            </div>
            <div class="feature-card">
                <i class="bi bi-shield-check icon-yellow icon-medium"></i>
                <h3 class="title-yellow title-small" style="margin: 15px 0 10px 0;">
                    @Localizer["Download_Feature_Secure_Title"]
                </h3>
                <p class="text-yellow-dim" style="font-size: 14px; margin: 0;">
                    @Localizer["Download_Feature_Secure_Description"]
                </p>
            </div>
        </div>
    </div>

    <!-- Back to Web Generator -->
    <div class="web-generator-section">
        <p class="text-theme-primary" style="font-size: 16px; margin: 0 0 20px 0;">
            @Localizer["Download_WebGenerator_Text"]
        </p>
        <a href="/passwordgenerator" class="btn-primary-yellow">
            <i class="bi bi-globe"></i>
            <span>@Localizer["Download_WebGenerator_Button"]</span>
        </a>
    </div>

</div>

@code
{
    public List<DownloadResponse> Downloads = new();

    private bool _isLoading = true;
    private bool _isDownloading;
    private string? _errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await DownloadService.GetLatestDownloadsAsync();
        
            if (result.IsFailure)
            {
                _errorMessage = result.Error;
                Logger.LogError("Failed to load downloads: {Error}", result.Error);
            }
            else
            {
                Downloads = result.Value!;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool IsDownloadAvailable(DownloadPlatform platform)
    {
        return Downloads?.Any(d => d.Platform == platform) ?? false;
    }

    private DownloadResponse? GetDownloadForPlatform(DownloadPlatform platform)
    {
        return Downloads?.FirstOrDefault(d => d.Platform == platform);
    }
    
    private async Task OnDownload(DownloadResponse download)
    {
        _isDownloading = true;
        _errorMessage = null;
        
        try
        {
            var result = await DownloadService.GetDownloadAsync(download.Id);

            if (result.IsFailure)
            {
                _errorMessage = result.Error;
                Logger.LogError("Failed to download: {Error}", result.Error);
                return;
            }
            
            var fileDownload = result.Value!;
            
            // Trigger browser download using JavaScript Interop
            await JSRuntime.InvokeVoidAsync(
                "fileDownload.downloadFile",
                fileDownload.FileName,
                fileDownload.ContentType,
                fileDownload.FileData);
            
            Logger.LogInformation("Successfully downloaded {FileName}", fileDownload.FileName);
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred during download";
            Logger.LogError(ex, "Unexpected error during download");
        }
        finally
        {
            _isDownloading = false;
            StateHasChanged();
        }
    }
}